<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å°ç£å¥½è¡Œé‡‘é–€ï½œå³æ™‚è·¯ç·šè§£è¬ï¼ˆAç·šç¤ºç¯„ï¼‰</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial}
    body{margin:0;background:#0b0c10;color:#f5f5f5}
    .wrap{max-width:880px;margin:0 auto;padding:18px}
    .card{background:#141622;border:1px solid rgba(255,255,255,.09);border-radius:18px;padding:14px;margin:12px 0;box-shadow:0 10px 28px rgba(0,0,0,.28)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.03);font-size:12px;opacity:.95}
    h1{font-size:22px;margin:8px 0 0}
    h2{font-size:16px;margin:0}
    .sub{opacity:.86;font-size:13px;line-height:1.65;margin-top:8px}
    .tiny{font-size:12px;opacity:.86;line-height:1.6}
    .muted{opacity:.72}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:#1d2140;color:#fff;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.secondary{background:#141622}
    .btn.good{background:#1f3d2c}
    .btn.warn{background:#40211d}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    select,input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f1120;color:#fff;font-size:16px}
    .progress{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar{height:100%;background:#7aa2ff;width:0%}
    .stop{border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;background:rgba(255,255,255,.03)}
    .stop.locked{opacity:.55}
    .stop.done{background:rgba(122,162,255,.12);border-color:rgba(122,162,255,.35)}
    .tag{display:inline-block;margin-right:6px;margin-top:6px;border:1px solid rgba(255,255,255,.12);padding:4px 8px;border-radius:999px;font-size:12px;opacity:.9}
    @media (max-width:760px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <div class="pill">ğŸšŒ å°ç£å¥½è¡Œé‡‘é–€ï½œå³æ™‚è·¯ç·šè§£è¬ï¼ˆç¤ºç¯„ï¼šAç·šï¼‰</div>
          <h1>åœ¨è»Šä¸Šä¹Ÿèƒ½ç©ï¼šåˆ°ç«™æ‰è§£é–ä¸‹ä¸€é—œ</h1>
          <div class="sub">
            ç©æ³•ï¼š<b>é–‹å®šä½ï¼ˆæˆ–æ‰‹å‹•é¸ç«™ï¼‰â†’ åœ¨ç«™é»é™„è¿‘è‡ªå‹•è§£é– â†’ è§£è¬ç­”å° â†’ å–å¾—é€šé—œç« </b>ã€‚<br/>
            é€™å¥—æ©Ÿåˆ¶çš„æ ¸å¿ƒæ˜¯æŠŠã€Œæ­ä¹˜è¡Œç‚ºã€ç›´æ¥è®ŠæˆéŠæˆ²é€²åº¦ï¼šè¶Šæ­è¶Šè§£é–ã€è¶Šç©è¶Šæƒ³ä¸‹è»Šçœ‹ã€‚
          </div>
        </div>
        <button class="btn secondary" id="resetBtn">é‡ç½®é€²åº¦</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">ğŸ¯ ç›®å‰è·¯ç·šï¼šAç·šï¼ˆæ°´é ­ç¿Ÿå±±ç·šï¼‰</div>
        <div class="pill">åˆ†æ•¸ï¼š<span id="score">0</span>ã€€é€£å‹ï¼š<span id="streak">0</span></div>
      </div>
      <div style="margin-top:10px">
        <div class="row">
          <div class="tiny muted">é€²åº¦</div>
          <div class="tiny muted"><span id="doneCount">0</span>/<span id="needCount">0</span></div>
        </div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="tiny muted" style="margin-top:8px" id="progressHint"></div>
      </div>
    </div>

    <div class="grid2">
      <div class="card" style="margin:0">
        <h2>â‘  è§£é–æ–¹å¼</h2>
        <div class="tiny muted" style="margin-top:8px">
          æ­£å¼ä¸Šç·šå»ºè­°ç”¨ GPS è§£é–ï¼›demo æˆ–å®¤å…§æ¸¬è©¦å¯æ”¹ç”¨ã€Œæ‰‹å‹•é¸ç«™ã€ã€‚
        </div>

        <div class="stop" style="margin-top:12px">
          <div class="row" style="justify-content:flex-start">
            <span class="tag">GPS è§£é–</span>
            <span class="tag">è¿‘è·é›¢è‡ªå‹•é–‹é—œå¡</span>
          </div>
          <div class="tiny muted" style="margin-top:8px" id="gpsStatus">å®šä½ç‹€æ…‹ï¼šæœªå•Ÿç”¨</div>
          <div class="row" style="margin-top:10px;justify-content:flex-start">
            <button class="btn" id="gpsBtn">å•Ÿç”¨å®šä½</button>
            <button class="btn secondary" id="gpsStopBtn">åœæ­¢å®šä½</button>
          </div>
          <div class="tiny muted" style="margin-top:8px">
            æé†’ï¼šiOS éœ€å…è¨±å®šä½ï¼›è‹¥åœ¨ LINE/IG å…§å»ºç€è¦½å™¨ï¼Œå»ºè­°ã€Œåœ¨ Safari/Chrome é–‹å•Ÿã€ã€‚
          </div>
        </div>

        <div class="stop" style="margin-top:12px">
          <div class="row" style="justify-content:flex-start">
            <span class="tag">æ‰‹å‹•é¸ç«™</span>
            <span class="tag">demo/ä¸é–‹å®šä½</span>
          </div>
          <div style="margin-top:8px">
            <select id="manualSelect"></select>
          </div>
          <div class="row" style="margin-top:10px;justify-content:flex-start">
            <button class="btn secondary" id="manualGoBtn">å‰å¾€è©²ç«™ä»»å‹™</button>
          </div>
        </div>

        <div class="stop" style="margin-top:12px">
          <div class="row" style="justify-content:flex-start">
            <span class="tag">è¼¸å…¥ç«™ç¢¼</span>
            <span class="tag">é…åˆ QR</span>
          </div>
          <div class="tiny muted" style="margin-top:8px">ä¾‹å¦‚ï¼šA06ã€A07ã€A10ï¼ˆæƒ QR ä¹Ÿå¯å¸¶ stop åƒæ•¸ï¼‰</div>
          <input id="codeInput" placeholder="è¼¸å…¥ç«™ç¢¼ï¼Œä¾‹å¦‚ A10" style="margin-top:8px" />
          <div class="row" style="margin-top:10px;justify-content:flex-start">
            <button class="btn secondary" id="codeGoBtn">å‰å¾€è©²ç«™ä»»å‹™</button>
          </div>
        </div>

      </div>

      <div class="card" style="margin:0">
        <h2>â‘¡ ç«™é»ä»»å‹™ï¼ˆåˆ°ç«™æ‰è§£é–ï¼‰</h2>
        <div id="missionBox" class="tiny muted" style="margin-top:10px">
          å…ˆå•Ÿç”¨ GPS æˆ–ç”¨ã€Œæ‰‹å‹•é¸ç«™ã€é€²å…¥ç¬¬ä¸€é—œã€‚
        </div>
        <div id="missionActions" class="row" style="margin-top:10px;justify-content:flex-start;display:none"></div>

        <div class="stop" style="margin-top:12px">
          <div class="tiny muted">ğŸ“ ä½ çš„å®šä½ï¼ˆè‹¥å·²å•Ÿç”¨ï¼‰</div>
          <div class="tiny" style="margin-top:6px" id="locText">å°šæœªå–å¾—å®šä½</div>
          <div class="tiny muted" style="margin-top:6px" id="nearText"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>â‘¢ é—œå¡åˆ—è¡¨ï¼ˆAç·šç¤ºç¯„ï¼‰</h2>
      <div class="sub">
        é€™è£¡å…ˆæ”¾ 8 é—œç¤ºç¯„ï¼ˆå¯æ“´æˆå®Œæ•´é€ç«™ï¼‰ã€‚<b>é€šé—œè¦å‰‡ï¼š</b>è¦ä¾é †åºå®Œæˆï¼ˆæ¨¡æ“¬ã€Œæ­ä¹˜è·¯ç·šã€ï¼‰ã€‚
      </div>
      <div id="stopsGrid" class="grid2" style="margin-top:12px"></div>
      <div class="tiny muted" style="margin-top:10px">
        â€» ç«™é»åº§æ¨™ç›®å‰ç‚ºç¤ºæ„å€¼ï¼šæ­£å¼ç‰ˆè«‹æ›¿æ›ç‚ºæ­£ç¢ºåº§æ¨™æˆ–æ”¹ç”¨ QR/ç«™ç¢¼è§£é–ã€‚
      </div>
    </div>

    <div class="card" id="finish" style="display:none">
      <div class="pill">ğŸ‰ Aç·šè§£è¬å®Œæˆ</div>
      <h2 style="margin-top:8px">ä½ å®Œæˆäº†ã€Œå³æ™‚è·¯ç·šè§£è¬ã€ï¼</h2>
      <div class="sub" id="finishText"></div>
      <div class="row" style="margin-top:12px;justify-content:flex-start">
        <button class="btn good" id="shareBtn">ä¸€éµåˆ†äº«</button>
        <button class="btn secondary" id="couponBtn">é¡¯ç¤ºå…Œæ›ç¢¼</button>
      </div>
      <div class="tiny" style="margin-top:10px" id="couponHint"></div>
    </div>
  </div>

<script>
/** ========= ç«™é»è³‡æ–™ï¼ˆAç·šç¤ºç¯„ï¼‰ =========
 * idï¼šç«™ç¢¼ï¼ˆç”¨æ–¼ QR / æ‰‹å‹•é¸ç«™ï¼‰
 * lat/lngï¼šç¤ºæ„åº§æ¨™ï¼ˆæ­£å¼ç‰ˆè«‹æ›æˆçœŸå¯¦åº§æ¨™ï¼‰
 * unlockRadiusMï¼šè·é›¢å¤šå°‘å…¬å°ºå…§è§£é–
 * qï¼šé¡Œç›®
 */
const A_STOPS = [
  { id:"A01", name:"é‡‘åŸè»Šç«™", tags:["èµ·é»","äº¤é€š"], lat:24.4320, lng:118.3170, unlockRadiusM:180,
    story:"å¾é‡‘åŸå‡ºç™¼ï¼Œä»Šå¤©ä½ ä¸æ˜¯è¶•è¡Œç¨‹ï¼Œè€Œæ˜¯åœ¨ã€æ­è»Šè§£è¬ã€ã€‚",
    q:{ t:"é€™æ¬¾éŠæˆ²ç‚ºä½•èƒ½æ¨å»£æ­ä¹˜ï¼Ÿ", a:["å› ç‚ºè¦åˆ°ç«™æ‰è§£é–","å› ç‚ºä¸éœ€è¦ç§»å‹•","å› ç‚ºè¶Šæ…¢è¶Šå¥½"], c:0 }
  },
  { id:"A04", name:"é«”è‚²é¤¨", tags:["è·¯ç·šç¯€é»"], lat:24.4340, lng:118.3230, unlockRadiusM:180,
    story:"è·¯ç·šä¸­ç¹¼é»ï¼šç”¨ä¸€å€‹å°ä»»å‹™æŠŠã€åœé ã€è®Šæˆã€ç¯€å¥ã€ã€‚",
    q:{ t:"è»Šä¸Šè§£è¬çš„é—œéµæ˜¯ä»€éº¼ï¼Ÿ", a:["ä¸€ç›´è·³ç«™","è·Ÿè‘—ç«™é»ç¯€å¥èµ°","åªç©å°„æ“Š"], c:1 }
  },
  { id:"A06", name:"è’å…‰æ¨“", tags:["åœ°æ¨™","é çœº"], lat:24.4325, lng:118.3145, unlockRadiusM:220,
    story:"åˆ°åœ°æ¨™æ™‚ï¼Œæœ€é©åˆæŠŠã€çœ‹è¦‹ã€è®Šæˆã€æƒ³åˆ†äº«ã€ã€‚",
    q:{ t:"åœ°æ¨™é—œå¡æœ€é©åˆåŠ ä»€éº¼ï¼Ÿ", a:["æ‹ç…§+ä¸€å¥è©±åˆ†äº«","ç¦æ­¢æ‹ç…§","ä¸çµ¦æç¤º"], c:0 }
  },
  { id:"A07", name:"æ°´é ­èšè½", tags:["èšè½","æ´‹æ¨“"], lat:24.4300, lng:118.3040, unlockRadiusM:220,
    story:"èšè½çš„å¥½ï¼Œä¸åœ¨è¡é»ï¼Œè€Œåœ¨æ…¢èµ°è§€å¯Ÿã€‚ä½ æº–å‚™å¥½é€²å…¥æ•…äº‹äº†å—ï¼Ÿ",
    q:{ t:"èšè½å‹æ™¯é»æœ€é©åˆçš„ç©æ³•ï¼Ÿ", a:["æ…¢èµ°è§€å¯Ÿ+è§£é–æ•…äº‹","ä¸€è·¯å¿«è·‘","åªçœ‹åœ°åœ–"], c:0 }
  },
  { id:"A08", name:"æ˜éºå¤è¡—", tags:["è€è¡—","æ‡·èˆŠ"], lat:24.4285, lng:118.3020, unlockRadiusM:220,
    story:"è€è¡—ä¸æ˜¯ã€è²·åˆ°ä»€éº¼ã€ï¼Œè€Œæ˜¯ã€ä½ æ€éº¼èµ°ã€ã€‚ç”¨è§£è¬æŠŠæ­¥è¡Œè®Šæœ‰è¶£ã€‚",
    q:{ t:"è€è¡—é—œå¡æœ€é©åˆçµåˆï¼Ÿ", a:["å°‹å¯¶ç·šç´¢","å¢åŠ æ’éšŠ","ä¸è®“äººåœ"], c:0 }
  },
  { id:"A09", name:"æ–‡å°å¯¶å¡”", tags:["é¢¨æ™¯é»","æ‰“å¡"], lat:24.4275, lng:118.3010, unlockRadiusM:220,
    story:"é€™ç¨®é¢¨æ™¯é»çš„è¡ŒéŠ·æœ€é©åˆï¼šä¸€å¥æ¨™èªï¼‹ä¸€å¼µç…§ç‰‡ï¼ä¸€å‰‡åˆ†äº«ã€‚",
    q:{ t:"ç¤¾ç¾¤åˆ†äº«çš„æœ€å°å–®ä½å¸¸æ˜¯ï¼Ÿ", a:["ä¸€å¥è©±+ä¸€å¼µç…§ç‰‡","é•·ç¯‡è«–æ–‡","å®Œå…¨ä¸èªª"], c:0 }
  },
  { id:"A10", name:"ç¿Ÿå±±å‘é“", tags:["è»äº‹åœ°æ™¯","æ²‰æµ¸"], lat:24.4075, lng:118.3035, unlockRadiusM:260,
    story:"å‘é“çš„æ²‰æµ¸æ„Ÿéå¸¸å¼·ã€‚æŠŠã€åˆ°æ­¤ä¸€éŠã€å‡ç´šæˆã€å®Œæˆä»»å‹™ã€ï¼Œè¨˜æ†¶æ›´æ·±ã€‚",
    q:{ t:"å‘é“é¡æ™¯é»æœ€èƒ½å¼·åŒ–ä»€éº¼ï¼Ÿ", a:["æ²‰æµ¸æ„Ÿ","ç„¡èŠæ„Ÿ","çœ‹ä¸åˆ°"], c:0 }
  },
  { id:"A11", name:"ç å±±", tags:["èšè½","æ”¶å°¾"], lat:24.4308, lng:118.2898, unlockRadiusM:220,
    story:"æœ€å¾Œä¸€é—œï¼šæŠŠä»Šæ—¥è·¯ç·šæ”¶æˆä¸€å¼µã€å®Œæˆå¾½ç« ã€ï¼Œä½ å°±èƒ½å»å…Œæ›/æŠ½çã€‚",
    q:{ t:"å®Œæˆå¾½ç« æœ€é©åˆåšä»€éº¼ï¼Ÿ", a:["åˆ°åº—å…Œæ›/æŠ½ç","ç«‹åˆ»åˆªæ‰","ä¸åˆ†äº«"], c:0 }
  },
];

const ROUTE_NAME = "Aç·šï¼ˆæ°´é ­ç¿Ÿå±±ç·šï¼‰";
const KEY = "km_live_route_riddle_A_v1";

const state = JSON.parse(localStorage.getItem(KEY) || "{}");
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function $(s){ return document.querySelector(s); }

state.done ||= [];       // å·²å®Œæˆç«™é» id
state.score ||= 0;
state.streak ||= 0;
state.current ||= A_STOPS[0].id; // ç›®å‰é—œå¡ç›®æ¨™ï¼ˆä¾é †åºï¼‰

const needCount = A_STOPS.length;

let watchId = null;
let lastPos = null;

function normCode(s){
  return (s||"").trim().toUpperCase().replace(/[^A-Z0-9]/g,"");
}

function getStop(id){
  return A_STOPS.find(x=>x.id===id);
}

function nextStopId(){
  const idx = A_STOPS.findIndex(s=>s.id===state.current);
  if(idx < 0) return A_STOPS[0].id;
  return A_STOPS[Math.min(idx+1, A_STOPS.length-1)].id;
}

function requiredStop(){
  // ç›®å‰å¿…é ˆå®Œæˆçš„é‚£ä¸€é—œï¼ˆé †åºé€²è¡Œï¼‰
  return getStop(state.current) || A_STOPS[0];
}

function haversineM(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

function render(){
  $("#score").textContent = String(state.score);
  $("#streak").textContent = String(state.streak);
  $("#doneCount").textContent = String(state.done.length);
  $("#needCount").textContent = String(needCount);

  const pct = (state.done.length / needCount) * 100;
  $("#bar").style.width = `${Math.min(100, pct)}%`;

  const req = requiredStop();
  $("#progressHint").textContent = `ä¸‹ä¸€é—œï¼š${req.id}ï½œ${req.name}ï¼ˆéœ€ä¾é †åºé€šé—œï¼‰`;

  // stops list
  const grid = $("#stopsGrid");
  grid.innerHTML = "";
  A_STOPS.forEach((st, idx)=>{
    const done = state.done.includes(st.id);
    const locked = !done && st.id !== state.current; // åªèƒ½åš current é‚£é—œ
    const div = document.createElement("div");
    div.className = "stop" + (done ? " done" : (locked ? " locked" : ""));
    div.innerHTML = `
      <div style="font-weight:900">${done?"âœ…":"${locked?"ğŸ”’":"ğŸ¯"}"} ${st.name}</div>
      <div class="tiny muted">ç«™ç¢¼ï¼š${st.id}</div>
      <div>${st.tags.map(t=>`<span class="tag">${t}</span>`).join("")}</div>
      <div class="tiny" style="margin-top:8px;opacity:.9">${st.story}</div>
      <div class="row" style="margin-top:10px;justify-content:flex-start">
        <button class="btn secondary" data-go="${st.id}" ${locked ? "disabled style='opacity:.5;cursor:not-allowed'" : ""}>å‰å¾€ä»»å‹™</button>
      </div>
    `;
    grid.appendChild(div);
  });

  grid.querySelectorAll("button[data-go]").forEach(b=>{
    b.onclick = ()=>openMission(b.getAttribute("data-go"));
  });

  // manual select options
  const sel = $("#manualSelect");
  if(sel.options.length === 0){
    A_STOPS.forEach(st=>{
      const opt = document.createElement("option");
      opt.value = st.id;
      opt.textContent = `${st.id}ï½œ${st.name}`;
      sel.appendChild(opt);
    });
  }

  // finish block
  if(state.done.length >= needCount){
    $("#finish").style.display = "";
    $("#finishText").textContent = `ä½ å®Œæˆäº† ${ROUTE_NAME} çš„å³æ™‚è§£è¬ï¼å»ºè­°ç”¨æ­¤ç•«é¢ä½œç‚ºã€Œåˆ°åº—å…Œæ›/æŠ½ç/å°è³¼å¥—ç¥¨ã€å…¥å£ã€‚`;
  }else{
    $("#finish").style.display = "none";
  }
}

function openMission(id){
  const req = requiredStop();
  const box = $("#missionBox");
  const act = $("#missionActions");
  act.style.display = "none";

  if(id !== req.id){
    box.className = "tiny muted";
    box.innerHTML = `ç›®å‰éœ€å…ˆå®Œæˆ <b>${req.id}ï½œ${req.name}</b> æ‰èƒ½è§£é–ä¸‹ä¸€é—œã€‚`;
    return;
  }

  // æ˜¯å¦å·²åœ¨é™„è¿‘ï¼ˆGPS è§£é–ï¼‰
  let nearOk = true;
  let distText = "";
  if(lastPos){
    const d = haversineM(lastPos.lat, lastPos.lng, req.lat, req.lng);
    nearOk = d <= req.unlockRadiusM;
    distText = `ï¼ˆè·é›¢ç´„ ${Math.round(d)}mï¼Œè§£é–ç¯„åœ ${req.unlockRadiusM}mï¼‰`;
  }else{
    // æ²’å®šä½å°±å…è¨±æ‰‹å‹• demo
    nearOk = true;
    distText = "ï¼ˆæœªå•Ÿç”¨å®šä½ï¼šä»¥ demo æ¨¡å¼é€²å…¥ï¼‰";
  }

  if(!nearOk){
    box.className = "tiny muted";
    box.innerHTML = `ä½ é‚„æ²’åˆ°é” <b>${req.name}</b> é™„è¿‘ï¼Œå…ˆæ­è»Šåˆ°ç«™å†æŒ‘æˆ°ï¼<br/><span class="muted">${distText}</span>`;
    return;
  }

  box.className = "tiny";
  box.innerHTML = `
    <div class="pill">ğŸ“ ${req.id}ï½œ${req.name}</div>
    <div style="margin-top:10px;opacity:.92">${req.story}</div>
    <div style="margin-top:10px;font-weight:900">è¬é¡Œï¼š</div>
    <div style="margin-top:6px">${req.q.t} <span class="muted">${distText}</span></div>
  `;

  act.innerHTML = "";
  req.q.a.forEach((opt, idx)=>{
    const b = document.createElement("button");
    b.className = "btn secondary";
    b.textContent = `${idx+1}. ${opt}`;
    b.onclick = ()=>answer(req, idx);
    act.appendChild(b);
  });
  act.style.display = "flex";
}

function answer(req, pickIdx){
  const box = $("#missionBox");
  const act = $("#missionActions");
  if(pickIdx === req.q.c){
    // correct
    state.done ||= [];
    if(!state.done.includes(req.id)) state.done.push(req.id);

    state.streak = (state.streak||0) + 1;
    const bonus = Math.min(30, state.streak * 3);
    state.score = (state.score||0) + 20 + bonus;

    // advance current
    const idx = A_STOPS.findIndex(s=>s.id===req.id);
    if(idx < A_STOPS.length - 1){
      state.current = A_STOPS[idx+1].id;
    }
    save();

    box.className = "tiny";
    box.innerHTML = `âœ… é€šé—œæˆåŠŸï¼ä½ ç²å¾— <b>${20+bonus}</b> åˆ†ï¼ˆé€£å‹åŠ æˆ +${bonus}ï¼‰ã€‚<br/>
      ä¸‹ä¸€é—œå·²è§£é–ï¼š<b>${requiredStop().id}ï½œ${requiredStop().name}</b>`;
    act.style.display = "none";
    render();
  }else{
    // wrong
    state.streak = 0;
    save();
    box.className = "tiny";
    box.innerHTML = `å†è©¦ä¸€æ¬¡ï½æç¤ºï¼šé€™é¡Œç­”æ¡ˆè·Ÿã€Œæ­ä¹˜åˆ°ç«™è§£é–ã€æˆ–ã€Œå°æµåˆ†äº«ã€æœ‰é—œã€‚`;
  }
}

function startGPS(){
  if(!navigator.geolocation){
    $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šæ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½";
    return;
  }
  if(watchId !== null) return;

  $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šè«‹å…è¨±å®šä½â€¦";
  watchId = navigator.geolocation.watchPosition(
    (pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const acc = Math.round(pos.coords.accuracy || 0);
      lastPos = { lat, lng, acc, t: Date.now() };

      $("#locText").textContent = `lat ${lat.toFixed(6)}, lng ${lng.toFixed(6)}ï¼ˆç²¾åº¦ç´„ ${acc}mï¼‰`;

      const req = requiredStop();
      const d = haversineM(lat, lng, req.lat, req.lng);
      const near = d <= req.unlockRadiusM;
      $("#nearText").textContent = `è·é›¢ä¸‹ä¸€é—œã€Œ${req.name}ã€ç´„ ${Math.round(d)}mï¼ˆ${near ? "âœ… å¯è§£é–" : "ğŸ”’ æœªåˆ°é”"}ï¼‰`;

      $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šå·²å•Ÿç”¨ï¼ˆå³æ™‚æ›´æ–°ä¸­ï¼‰";
      // å¦‚æœå·²ç¶“é è¿‘å°±è‡ªå‹•æ‰“é–‹ä»»å‹™
      if(near) openMission(req.id);
    },
    (err)=>{
      $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šå•Ÿç”¨å¤±æ•—ï¼ˆè«‹åœ¨ç€è¦½å™¨è¨­å®šå…è¨±å®šä½ï¼‰";
      $("#locText").textContent = `éŒ¯èª¤ï¼š${err.message || err.code}`;
    },
    { enableHighAccuracy: true, maximumAge: 2000, timeout: 12000 }
  );
}

function stopGPS(){
  if(watchId !== null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šå·²åœæ­¢";
    $("#nearText").textContent = "";
  }
}

function showCoupon(){
  const device = (state.deviceId ||= Math.random().toString(16).slice(2,10)).toUpperCase();
  save();
  $("#couponHint").textContent = `ç¤ºç¯„å…Œæ›ç¢¼ï¼šKM-A-RIDDLE-${device}ï¼ˆæ­£å¼ç‰ˆå»ºè­°å¾Œç«¯æ ¸éŠ·ï¼‰`;
}

function share(){
  const text = `æˆ‘å‰›å®Œæˆå°ç£å¥½è¡Œé‡‘é–€ ${ROUTE_NAME} çš„ã€Œå³æ™‚è·¯ç·šè§£è¬ã€ğŸšŒğŸ§© åˆ†æ•¸ ${state.score}ï¼#å°ç£å¥½è¡Œ #é‡‘é–€`;
  if(navigator.share){
    navigator.share({ title:"å°ç£å¥½è¡Œé‡‘é–€ï½œå³æ™‚è·¯ç·šè§£è¬", text }).catch(()=>{});
  }else{
    navigator.clipboard?.writeText(text).then(()=>alert("å·²è¤‡è£½åˆ†äº«æ–‡æ¡ˆåˆ°å‰ªè²¼ç°¿ï¼")).catch(()=>alert(text));
  }
}

// buttons
$("#gpsBtn").onclick = startGPS;
$("#gpsStopBtn").onclick = stopGPS;

$("#manualGoBtn").onclick = ()=>openMission($("#manualSelect").value);
$("#codeGoBtn").onclick = ()=>{
  const code = normCode($("#codeInput").value);
  openMission(code);
};

$("#resetBtn").onclick = ()=>{
  localStorage.removeItem(KEY);
  location.href = location.pathname + "?v=" + Date.now();
};

$("#couponBtn").onclick = showCoupon;
$("#shareBtn").onclick = share;

// boot: support ?stop=A10
(function boot(){
  $("#needCount").textContent = String(needCount);
  render();

  const url = new URL(location.href);
  const stop = url.searchParams.get("stop");
  if(stop){
    const code = normCode(stop);
    // è‹¥ URL æŒ‡å‘çš„ä¸æ˜¯ currentï¼Œä»éµå¾ªé †åºè¦å‰‡
    $("#codeInput").value = code;
    openMission(code);
  }else{
    // è‡ªå‹•èšç„¦åˆ°ç•¶å‰é—œå¡
    openMission(state.current);
  }
})();
</script>
</body>
</html>
