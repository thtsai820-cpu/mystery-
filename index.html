<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å°ç£å¥½è¡Œé‡‘é–€ï½œå³æ™‚è·¯ç·šè§£è¬ï¼ˆAç·šç¤ºç¯„ï¼‰</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial}
    body{margin:0;background:#0b0c10;color:#f5f5f5}
    .wrap{max-width:880px;margin:0 auto;padding:18px}
    .card{background:#141622;border:1px solid rgba(255,255,255,.09);border-radius:18px;padding:14px;margin:12px 0;box-shadow:0 10px 28px rgba(0,0,0,.28)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.03);font-size:12px;opacity:.95}
    h1{font-size:22px;margin:8px 0 0}
    h2{font-size:16px;margin:0}
    .sub{opacity:.86;font-size:13px;line-height:1.65;margin-top:8px}
    .tiny{font-size:12px;opacity:.86;line-height:1.6}
    .muted{opacity:.72}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:#1d2140;color:#fff;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.secondary{background:#141622}
    .btn.good{background:#1f3d2c}
    .btn.warn{background:#40211d}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    select,input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f1120;color:#fff;font-size:16px}
    .progress{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar{height:100%;background:#7aa2ff;width:0%}
    .stop{border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;background:rgba(255,255,255,.03)}
    .stop.locked{opacity:.55}
    .stop.done{background:rgba(122,162,255,.12);border-color:rgba(122,162,255,.35)}
    .tag{display:inline-block;margin-right:6px;margin-top:6px;border:1px solid rgba(255,255,255,.12);padding:4px 8px;border-radius:999px;font-size:12px;opacity:.9}
    @media (max-width:760px){.grid2{grid-template-columns:1fr}}
  </style>
</head>

<body>

<!-- ===== TM å¹³å°å°è¦½æ¨¡çµ„ï¼ˆmysteryï¼‰ ===== -->
<script>
  var PORTAL_URL = "https://thtsai820-cpu.github.io/TM/";

  function getStopParam(){
    var p = new URLSearchParams(location.search);
    return String(p.get("stop") || "A01").toUpperCase();
  }

  var STOP_INFO = {
    A01:{ name:"é‡‘åŸè»Šç«™" },
    A02:{ name:"è’å…‰æ¨“" },
    A03:{ name:"æ°´é ­èšè½" },
    A04:{ name:"ç¿Ÿå±±å‘é“" }
  };

  var CURRENT_STOP = getStopParam();
  var CURRENT_STOP_NAME = (STOP_INFO[CURRENT_STOP] && STOP_INFO[CURRENT_STOP].name) ? STOP_INFO[CURRENT_STOP].name : CURRENT_STOP;
</script>

<div style="
  position:sticky; top:0; z-index:9999;
  background:#141622;
  border-bottom:1px solid rgba(255,255,255,.12);
  padding:10px 12px;
  font-family:system-ui,-apple-system,'Noto Sans TC',Segoe UI,Roboto,Arial;
">
  <div style="max-width:900px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span style="border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:4px 8px;font-size:12px;color:rgba(255,255,255,.9);">
        ğŸ§© å³æ™‚è§£è¬
      </span>
      <span style="border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:4px 8px;font-size:12px;color:rgba(255,255,255,.9);">
        ğŸ“ ç›®å‰ç«™é»ï¼š<b id="topStopName"></b>ï¼ˆ<span id="topStopId"></span>ï¼‰
      </span>
    </div>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button onclick="location.href=PORTAL_URL+'route-a.html'"
        style="border:1px solid rgba(255,255,255,.18);background:rgba(122,162,255,.95);color:#0b0c10;border-radius:12px;padding:8px 10px;font-weight:1000;cursor:pointer;">
        ğŸ§­ Aç·šæ€éº¼æ­
      </button>
      <button onclick="location.href=PORTAL_URL+'#games'"
        style="border:1px solid rgba(255,255,255,.18);background:transparent;color:#fff;border-radius:12px;padding:8px 10px;cursor:pointer;">
        ğŸ® åˆ‡æ›å…¶ä»–éŠæˆ²
      </button>
      <button onclick="location.href=PORTAL_URL+'?v='+Date.now()"
        style="border:1px solid rgba(255,255,255,.18);background:#1d2140;color:#fff;border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer;">
        â¬… å›é¦–é 
      </button>
    </div>
  </div>
</div>

<script>
  document.getElementById("topStopName").textContent = CURRENT_STOP_NAME;
  document.getElementById("topStopId").textContent = CURRENT_STOP;
</script>
<!-- ===== æ¨¡çµ„çµæŸ ===== -->

<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <div class="pill" id="pagePill">ğŸšŒ å°ç£å¥½è¡Œé‡‘é–€ï½œå³æ™‚è·¯ç·šè§£è¬ï¼ˆç¤ºç¯„ï¼šAç·šï¼‰</div>
        <h1>åœ¨è»Šä¸Šä¹Ÿèƒ½ç©ï¼šåˆ°ç«™æ‰è§£é–ä¸‹ä¸€é—œ</h1>
        <div class="sub">
          ç©æ³•ï¼š<b>é–‹å®šä½ï¼ˆæˆ–æ‰‹å‹•é¸ç«™ï¼‰â†’ åœ¨ç«™é»é™„è¿‘è‡ªå‹•è§£é– â†’ è§£è¬ç­”å° â†’ å–å¾—é€šé—œç« </b>ã€‚<br/>
          æ ¸å¿ƒæ¦‚å¿µï¼šæŠŠã€Œæ­ä¹˜è¡Œç‚ºã€è®ŠæˆéŠæˆ²é€²åº¦ï¼šè¶Šæ­è¶Šè§£é–ã€è¶Šç©è¶Šæƒ³ä¸‹è»Šçœ‹ã€‚
        </div>
      </div>
      <button class="btn secondary" id="resetBtn">é‡ç½®é€²åº¦</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="pill">ğŸ¯ ç›®å‰è·¯ç·šï¼šAç·šï¼ˆæ°´é ­ç¿Ÿå±±ç·šï¼‰</div>
      <div class="pill">åˆ†æ•¸ï¼š<span id="score">0</span>ã€€é€£å‹ï¼š<span id="streak">0</span></div>
    </div>
    <div style="margin-top:10px">
      <div class="row">
        <div class="tiny muted">é€²åº¦</div>
        <div class="tiny muted"><span id="doneCount">0</span>/<span id="needCount">0</span></div>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="tiny muted" style="margin-top:8px" id="progressHint"></div>
    </div>
  </div>

  <div class="grid2">
    <div class="card" style="margin:0">
      <h2>â‘  è§£é–æ–¹å¼</h2>
      <div class="tiny muted" style="margin-top:8px">
        æ­£å¼ä¸Šç·šå»ºè­°ç”¨ GPS è§£é–ï¼›demo æˆ–å®¤å…§æ¸¬è©¦å¯æ”¹ç”¨ã€Œæ‰‹å‹•é¸ç«™ã€ã€‚
      </div>

      <div class="stop" style="margin-top:12px">
        <div class="row" style="justify-content:flex-start">
          <span class="tag">GPS è§£é–</span>
          <span class="tag">è¿‘è·é›¢è‡ªå‹•é–‹é—œå¡</span>
        </div>
        <div class="tiny muted" style="margin-top:8px" id="gpsStatus">å®šä½ç‹€æ…‹ï¼šæœªå•Ÿç”¨</div>
        <div class="row" style="margin-top:10px;justify-content:flex-start">
          <button class="btn" id="gpsBtn">å•Ÿç”¨å®šä½</button>
          <button class="btn secondary" id="gpsStopBtn">åœæ­¢å®šä½</button>
        </div>
        <div class="tiny muted" style="margin-top:8px">
          æé†’ï¼šiOS éœ€å…è¨±å®šä½ï¼›è‹¥åœ¨ LINE/IG å…§å»ºç€è¦½å™¨ï¼Œå»ºè­°ã€Œåœ¨ Safari/Chrome é–‹å•Ÿã€ã€‚
        </div>
      </div>

      <div class="stop" style="margin-top:12px">
        <div class="row" style="justify-content:flex-start">
          <span class="tag">æ‰‹å‹•é¸ç«™</span>
          <span class="tag">demo/ä¸é–‹å®šä½</span>
        </div>
        <div style="margin-top:8px">
          <select id="manualSelect"></select>
        </div>
        <div class="row" style="margin-top:10px;justify-content:flex-start">
          <button class="btn secondary" id="manualGoBtn">å‰å¾€è©²ç«™ä»»å‹™</button>
        </div>
      </div>

      <div class="stop" style="margin-top:12px">
        <div class="row" style="justify-content:flex-start">
          <span class="tag">è¼¸å…¥ç«™ç¢¼</span>
          <span class="tag">é…åˆ QR</span>
        </div>
        <div class="tiny muted" style="margin-top:8px">ä¾‹å¦‚ï¼šA06ã€A07ã€A10ï¼ˆæƒ QR ä¹Ÿå¯å¸¶ stop åƒæ•¸ï¼‰</div>
        <input id="codeInput" placeholder="è¼¸å…¥ç«™ç¢¼ï¼Œä¾‹å¦‚ A10" style="margin-top:8px" />
        <div class="row" style="margin-top:10px;justify-content:flex-start">
          <button class="btn secondary" id="codeGoBtn">å‰å¾€è©²ç«™ä»»å‹™</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin:0">
      <h2>â‘¡ ç«™é»ä»»å‹™ï¼ˆåˆ°ç«™æ‰è§£é–ï¼‰</h2>
      <div id="missionBox" class="tiny muted" style="margin-top:10px">
        å…ˆå•Ÿç”¨ GPS æˆ–ç”¨ã€Œæ‰‹å‹•é¸ç«™ã€é€²å…¥ç¬¬ä¸€é—œã€‚
      </div>
      <div id="missionActions" class="row" style="margin-top:10px;justify-content:flex-start;display:none"></div>

      <div class="stop" style="margin-top:12px">
        <div class="tiny muted">ğŸ“ ä½ çš„å®šä½ï¼ˆè‹¥å·²å•Ÿç”¨ï¼‰</div>
        <div class="tiny" style="margin-top:6px" id="locText">å°šæœªå–å¾—å®šä½</div>
        <div class="tiny muted" style="margin-top:6px" id="nearText"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>â‘¢ é—œå¡åˆ—è¡¨ï¼ˆAç·šç¤ºç¯„ï¼‰</h2>
    <div class="sub">
      é€™è£¡æ”¾ç¤ºç¯„é—œå¡ï¼ˆå¯æ“´æˆå®Œæ•´é€ç«™ï¼‰ã€‚<b>é€šé—œè¦å‰‡ï¼š</b>éœ€ä¾é †åºå®Œæˆï¼ˆæ¨¡æ“¬ã€Œæ­ä¹˜è·¯ç·šã€ï¼‰ã€‚
    </div>
    <div id="stopsGrid" class="grid2" style="margin-top:12px"></div>
    <div class="tiny muted" style="margin-top:10px">
      â€» ç«™é»åº§æ¨™ç›®å‰ç‚ºç¤ºæ„å€¼ï¼šæ­£å¼ç‰ˆè«‹æ›¿æ›ç‚ºæ­£ç¢ºåº§æ¨™æˆ–æ”¹ç”¨ QR/ç«™ç¢¼è§£é–ã€‚
    </div>
  </div>

  <div class="card" id="finish" style="display:none">
    <div class="pill">ğŸ‰ Aç·šè§£è¬å®Œæˆ</div>
    <h2 style="margin-top:8px">ä½ å®Œæˆäº†ã€Œå³æ™‚è·¯ç·šè§£è¬ã€ï¼</h2>
    <div class="sub" id="finishText"></div>
    <div class="row" style="margin-top:12px;justify-content:flex-start" id="finishRow">
      <button class="btn good" id="shareBtn">ä¸€éµåˆ†äº«</button>
      <button class="btn secondary" id="couponBtn">é¡¯ç¤ºå…Œæ›ç¢¼</button>
    </div>
    <div class="tiny" style="margin-top:10px" id="couponHint"></div>

    <!-- ===== ä½ç¢³æˆç¸¾ï¼ˆå®Œæˆå¾Œé¡¯ç¤ºï¼‰===== -->
    <div class="stop" style="margin-top:12px;display:none" id="carbonBox" aria-live="polite">
      <div class="row" style="justify-content:flex-start">
        <span class="tag">ğŸŒ± ä½ç¢³æˆç¸¾</span>
        <span class="tag">æ­å¥½è¡Œï¼æ¸›ç¢³è¡Œå‹•</span>
      </div>

      <div class="tiny" style="margin-top:8px">
        ä½ æœ¬è¶Ÿå®Œæˆ Aç·šè§£è¬çš„ã€Œä½ç¢³æˆæœã€å¦‚ä¸‹ï¼ˆä¼°ç®—å€¼ï¼Œç”¨æ–¼æ•™è‚²å±•ç¤ºï¼‰ï¼š
      </div>

      <div class="row" style="margin-top:10px;justify-content:flex-start;gap:12px;flex-wrap:wrap">
        <div class="pill">æ¸›ç¢³ï¼š<b id="co2SavedText">--</b></div>
        <div class="pill">ç¶ è¡Œé»æ•¸ï¼š<b id="greenPointsText">--</b></div>
        <div class="pill">ç›¸ç•¶æ–¼ï¼š<b id="equivText">--</b></div>
      </div>

      <div class="tiny muted" style="margin-top:10px" id="carbonNote"></div>

      <div class="row" style="margin-top:10px;justify-content:flex-start">
        <button class="btn secondary" id="shareGreenBtn">ğŸ“£ åˆ†äº«ä½ç¢³æˆç¸¾</button>
      </div>
    </div>
    <!-- ===== ä½ç¢³æˆç¸¾çµæŸ ===== -->

  </div>
</div>

<script>
/** ========= ç«™é»è³‡æ–™ï¼ˆAç·šç¤ºç¯„ï¼‰ ========= */
var A_STOPS = [
  { id:"A01", name:"é‡‘åŸè»Šç«™", tags:["èµ·é»","äº¤é€š"], lat:24.43346, lng:118.31989, unlockRadiusM:200,
    story:"å¾é‡‘åŸå‡ºç™¼ï¼Œä»Šå¤©ä½ ä¸æ˜¯è¶•è¡Œç¨‹ï¼Œè€Œæ˜¯åœ¨ã€æ­è»Šè§£è¬ã€ã€‚",
    q:{ t:"é€™æ¬¾éŠæˆ²ç‚ºä½•èƒ½æ¨å»£æ­ä¹˜ï¼Ÿ", a:["å› ç‚ºè¦åˆ°ç«™æ‰è§£é–","å› ç‚ºä¸éœ€è¦ç§»å‹•","å› ç‚ºè¶Šæ…¢è¶Šå¥½"], c:0 }
  },
  { id:"A06", name:"è’å…‰æ¨“", tags:["åœ°æ¨™","é çœº"], lat:24.42497, lng:118.31900, unlockRadiusM:230,
    story:"åˆ°åœ°æ¨™æ™‚ï¼Œæœ€é©åˆæŠŠã€çœ‹è¦‹ã€è®Šæˆã€æƒ³åˆ†äº«ã€ã€‚",
    q:{ t:"åœ°æ¨™é—œå¡æœ€é©åˆåŠ ä»€éº¼ï¼Ÿ", a:["æ‹ç…§+ä¸€å¥è©±åˆ†äº«","ç¦æ­¢æ‹ç…§","ä¸çµ¦æç¤º"], c:0 }
  },
  { id:"A07", name:"æ°´é ­èšè½", tags:["èšè½","æ´‹æ¨“"], lat:24.41147, lng:118.29996, unlockRadiusM:260,
    story:"èšè½çš„å¥½ï¼Œä¸åœ¨è¡é»ï¼Œè€Œåœ¨æ…¢èµ°è§€å¯Ÿã€‚ä½ æº–å‚™å¥½é€²å…¥æ•…äº‹äº†å—ï¼Ÿ",
    q:{ t:"èšè½å‹æ™¯é»æœ€é©åˆçš„ç©æ³•ï¼Ÿ", a:["æ…¢èµ°è§€å¯Ÿ+è§£é–æ•…äº‹","ä¸€è·¯å¿«è·‘","åªçœ‹åœ°åœ–"], c:0 }
  },
  { id:"A08", name:"æ˜éºè€è¡—", tags:["è€è¡—","æ‡·èˆŠ"], lat:24.40371, lng:118.30883, unlockRadiusM:240,
    story:"è€è¡—ä¸æ˜¯ã€è²·åˆ°ä»€éº¼ã€ï¼Œè€Œæ˜¯ã€ä½ æ€éº¼èµ°ã€ã€‚ç”¨è§£è¬æŠŠæ­¥è¡Œè®Šæœ‰è¶£ã€‚",
    q:{ t:"è€è¡—é—œå¡æœ€é©åˆçµåˆï¼Ÿ", a:["å°‹å¯¶ç·šç´¢","å¢åŠ æ’éšŠ","ä¸è®“äººåœ"], c:0 }
  },
  { id:"A09", name:"æ–‡è‡ºå¯¶å¡”", tags:["é¢¨æ™¯é»","æ‰“å¡"], lat:24.39879, lng:118.30600, unlockRadiusM:240,
    story:"é¢¨æ™¯é»çš„è¡ŒéŠ·æœ€é©åˆï¼šä¸€å¥æ¨™èªï¼‹ä¸€å¼µç…§ç‰‡ï¼ä¸€å‰‡åˆ†äº«ã€‚",
    q:{ t:"ç¤¾ç¾¤åˆ†äº«çš„æœ€å°å–®ä½å¸¸æ˜¯ï¼Ÿ", a:["ä¸€å¥è©±+ä¸€å¼µç…§ç‰‡","é•·ç¯‡è«–æ–‡","å®Œå…¨ä¸èªª"], c:0 }
  },
  { id:"A10", name:"ç¿Ÿå±±å‘é“", tags:["è»äº‹åœ°æ™¯","æ²‰æµ¸"], lat:24.39030, lng:118.32054, unlockRadiusM:280,
    story:"å‘é“çš„æ²‰æµ¸æ„Ÿå¾ˆå¼·ã€‚æŠŠã€åˆ°æ­¤ä¸€éŠã€å‡ç´šæˆã€å®Œæˆä»»å‹™ã€ï¼Œè¨˜æ†¶æ›´æ·±ã€‚",
    q:{ t:"å‘é“é¡æ™¯é»æœ€èƒ½å¼·åŒ–ä»€éº¼ï¼Ÿ", a:["æ²‰æµ¸æ„Ÿ","ç„¡èŠæ„Ÿ","çœ‹ä¸åˆ°"], c:0 }
  },
  { id:"A11", name:"ç å±±èšè½", tags:["èšè½","æ”¶å°¾"], lat:24.40148, lng:118.32058, unlockRadiusM:260,
    story:"æœ€å¾Œä¸€é—œï¼šæŠŠä»Šæ—¥è·¯ç·šæ”¶æˆä¸€å¼µã€å®Œæˆå¾½ç« ã€ï¼Œä½ å°±èƒ½å»å…Œæ›/æŠ½çã€‚",
    q:{ t:"å®Œæˆå¾½ç« æœ€é©åˆåšä»€éº¼ï¼Ÿ", a:["åˆ°åº—å…Œæ›/æŠ½ç","ç«‹åˆ»åˆªæ‰","ä¸åˆ†äº«"], c:0 }
  }
];

var ROUTE_NAME = "Aç·šï¼ˆæ°´é ­ç¿Ÿå±±ç·šï¼‰";
var KEY = "km_live_route_riddle_A_v1";

function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function $(s){ return document.querySelector(s); }

var state = {};
try { state = JSON.parse(localStorage.getItem(KEY) || "{}"); }
catch(e){ state = {}; }

/* === ç›¸å®¹å¯«æ³•ï¼šä¸ä½¿ç”¨ ||= / ?. === */
if (!state.startAt) state.startAt = Date.now();
if (!Array.isArray(state.done)) state.done = [];
if (typeof state.score !== "number") state.score = 0;
if (typeof state.streak !== "number") state.streak = 0;
if (!state.current) state.current = A_STOPS[0].id;

var LEADERBOARD_URL = "https://thtsai820-cpu.github.io/TM/leaderboard.html";
var needCount = A_STOPS.length;

var watchId = null;
var lastPos = null;

function normCode(s){
  return String(s||"").trim().toUpperCase().replace(/[^A-Z0-9]/g,"");
}
function getStop(id){
  for(var i=0;i<A_STOPS.length;i++){
    if(A_STOPS[i].id === id) return A_STOPS[i];
  }
  return null;
}
function requiredStop(){
  return getStop(state.current) || A_STOPS[0];
}
function haversineM(lat1, lon1, lat2, lon2){
  var R = 6371000;
  function toRad(d){ return d * Math.PI / 180; }
  var dLat = toRad(lat2 - lat1);
  var dLon = toRad(lon2 - lon1);
  var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
          Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
          Math.sin(dLon/2)*Math.sin(dLon/2);
  return 2 * R * Math.asin(Math.sqrt(a));
}

/* ================== ä½ç¢³ä¼°ç®—æ¨¡çµ„ï¼ˆå‰ç«¯ç‰ˆï¼‰ ================== */
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

// ä¼°ç®—ï¼šä»¥ã€Œå®Œæˆé—œå¡æ•¸ã€æ¨ä¼°ç§»å‹•è·é›¢ï¼ˆæ•™è‚²å±•ç¤ºç”¨ï¼‰
// ä¹‹å¾Œè‹¥æœ‰çœŸå¯¦ç«™é»è·é›¢ï¼Œå¯æ”¹æˆç«™é»é–“è·é›¢åŠ ç¸½
function estimateKmByStops(stopsCount){
  // Aç·šç¤ºç¯„ï¼šæ¯é—œå¹³å‡ 2.2 kmï¼ˆå¯èª¿ï¼‰
  var km = stopsCount * 2.2;
  return clamp(km, 2, 35);
}

// ç°¡åŒ–æ’æ”¾ä¿‚æ•¸ï¼ˆæ•™è‚²å±•ç¤ºç”¨ï¼Œå–®ä½ï¼šg CO2 / kmï¼‰
var EF_SCOOTER_G_PER_KM = 85;
var EF_BUS_PER_CAP_G_PER_KM = 30;

function carbonEquivalent(co2g){
  // æ±½æ²¹ç‡ƒç‡’ç´„ 2.31 kg CO2 / Lï¼ˆæ•™è‚²æ›ç®—ç”¨ï¼‰
  var gasolineL = (co2g/1000) / 2.31;
  var gasolineMl = Math.round(gasolineL * 1000);

  // ç”¨é›»ç¤ºæ„ï¼ˆæ•™è‚²å±•ç¤ºç”¨ï¼Œé¿å…å¯«æ­»å°ç£é›»åŠ›ä¿‚æ•¸ï¼‰
  var wh = Math.round((co2g/1000) * 600);

  if(co2g < 200){
    return "æ±½æ²¹ç´„ " + gasolineMl + " mL";
  }else if(co2g < 1000){
    return "æ±½æ²¹ç´„ " + gasolineMl + " mLï¼Œç´„ " + wh + " Wh ç”¨é›»";
  }else{
    return "æ±½æ²¹ç´„ " + gasolineMl + " mLï¼Œç´„ " + wh + " Wh ç”¨é›»";
  }
}

function updateCarbonSummary(timeSec){
  var carbonBox = document.getElementById("carbonBox");
  var co2El = document.getElementById("co2SavedText");
  var gpEl  = document.getElementById("greenPointsText");
  var eqEl  = document.getElementById("equivText");
  var noteEl= document.getElementById("carbonNote");
  var shareBtn = document.getElementById("shareGreenBtn");

  if(!carbonBox || !co2El || !gpEl || !eqEl || !noteEl) return;

  var doneN = (state.done && state.done.length) ? state.done.length : 0;
  var km = estimateKmByStops(doneN);

  var savedG = Math.max(0, Math.round((EF_SCOOTER_G_PER_KM - EF_BUS_PER_CAP_G_PER_KM) * km));
  var savedKg = (savedG/1000);

  // ç¶ è¡Œé»æ•¸ï¼š1 é» = 10 gCO2ï¼ˆæ•¸å­—ç›´è¦ºï¼‰
  var greenPoints = Math.max(1, Math.round(savedG / 10));

  co2El.textContent = savedKg.toFixed(2) + " kg COâ‚‚e";
  gpEl.textContent  = String(greenPoints) + " é»";
  eqEl.textContent  = carbonEquivalent(savedG);

  noteEl.textContent =
    "ä¼°ç®—åŸºç¤ï¼šå®Œæˆ " + doneN + " é—œ â‰ˆ " + km.toFixed(1) + " kmï¼›" +
    "ä»¥ã€ŒçŸ­ç¨‹æ©Ÿè»Š vs. å…¬è»Šäººå‡ã€å·®é¡ä¼°ç®—ã€‚ï¼ˆæ•™è‚²å±•ç¤ºç”¨ï¼Œæœªç´å…¥å¯¦éš›è¼‰å®¢ç‡èˆ‡è·¯æ®µå·®ç•°ï¼‰";

  carbonBox.style.display = "";

  var shareText =
    "ğŸŒ±æˆ‘å‰›å®Œæˆå°ç£å¥½è¡Œé‡‘é–€ Aç·šã€Œå³æ™‚è§£è¬ã€ï¼" +
    "æœ¬è¶Ÿä¼°ç®—æ¸›ç¢³ " + savedKg.toFixed(2) + " kg COâ‚‚eï¼ˆç¶ è¡Œé»æ•¸ " + greenPoints + "ï¼‰" +
    "ï¼Œå®Œæˆæ™‚é–“ " + timeSec + " ç§’ã€‚" +
    " #å°ç£å¥½è¡Œ #é‡‘é–€ #ä½ç¢³æ—…è¡Œ";

  if(shareBtn){
    shareBtn.onclick = function(){
      if(navigator.share){
        navigator.share({ title:"å°ç£å¥½è¡Œé‡‘é–€ï½œä½ç¢³æˆç¸¾", text: shareText })["catch"](function(){});
      }else{
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(shareText)
            .then(function(){ alert("å·²è¤‡è£½ä½ç¢³åˆ†äº«æ–‡æ¡ˆåˆ°å‰ªè²¼ç°¿ï¼"); })["catch"](function(){ alert(shareText); });
        }else{
          alert(shareText);
        }
      }
    };
  }
}
/* ================== ä½ç¢³ä¼°ç®—æ¨¡çµ„çµæŸ ================== */

function render(){
  $("#score").textContent = String(state.score);
  $("#streak").textContent = String(state.streak);
  $("#doneCount").textContent = String(state.done.length);
  $("#needCount").textContent = String(needCount);

  var pct = (state.done.length / needCount) * 100;
  $("#bar").style.width = (pct > 100 ? "100" : String(pct)) + "%";

  var req = requiredStop();
  $("#progressHint").textContent = "ä¸‹ä¸€é—œï¼š" + req.id + "ï½œ" + req.name + "ï¼ˆéœ€ä¾é †åºé€šé—œï¼‰";

  var grid = $("#stopsGrid");
  grid.innerHTML = "";

  for(var i=0;i<A_STOPS.length;i++){
    var st = A_STOPS[i];
    var done = state.done.indexOf(st.id) >= 0;
    var locked = (!done && st.id !== state.current);

    var div = document.createElement("div");
    div.className = "stop" + (done ? " done" : (locked ? " locked" : ""));

    var icon = done ? "âœ…" : (locked ? "ğŸ”’" : "ğŸ¯");

    var tagsHtml = "";
    for(var t=0;t<st.tags.length;t++){
      tagsHtml += "<span class='tag'>" + st.tags[t] + "</span>";
    }

    div.innerHTML =
      "<div style='font-weight:900'>" + icon + " " + st.name + "</div>" +
      "<div class='tiny muted'>ç«™ç¢¼ï¼š" + st.id + "</div>" +
      "<div>" + tagsHtml + "</div>" +
      "<div class='tiny' style='margin-top:8px;opacity:.9'>" + st.story + "</div>" +
      "<div class='row' style='margin-top:10px;justify-content:flex-start'>" +
        "<button class='btn secondary' data-go='" + st.id + "'" +
        (locked ? " disabled style='opacity:.5;cursor:not-allowed'" : "") +
        ">å‰å¾€ä»»å‹™</button>" +
      "</div>";

    grid.appendChild(div);
  }

  var buttons = grid.querySelectorAll("button[data-go]");
  for(var b=0;b<buttons.length;b++){
    (function(btn){
      btn.onclick = function(){ openMission(btn.getAttribute("data-go")); };
    })(buttons[b]);
  }

  var sel = $("#manualSelect");
  if(sel && sel.options.length === 0){
    for(var j=0;j<A_STOPS.length;j++){
      var opt = document.createElement("option");
      opt.value = A_STOPS[j].id;
      opt.textContent = A_STOPS[j].id + "ï½œ" + A_STOPS[j].name;
      sel.appendChild(opt);
    }
  }

  if(state.done.length >= needCount){
    $("#finish").style.display = "";
    var timeSec = Math.max(1, Math.round((Date.now() - (state.startAt || Date.now())) / 1000));
    var stopId = normCode(CURRENT_STOP);
    $("#finishText").textContent =
      "ä½ å®Œæˆäº† " + ROUTE_NAME + " çš„å³æ™‚è§£è¬ï¼ï¼ˆåˆ†æ•¸ï¼š" + state.score + "ï½œæ™‚é–“ï¼š" + timeSec + " ç§’ï¼‰" +
      " å»ºè­°æŠŠæ­¤ç•«é¢ä½œç‚ºã€Œåˆ°åº—å…Œæ›/æŠ½ç/å°è³¼å¥—ç¥¨ã€å…¥å£ã€‚";

    // >>> æ–°å¢ï¼šå®Œæˆæ™‚æ›´æ–°ä½ç¢³æˆç¸¾ <<<
    updateCarbonSummary(timeSec);

    if(!document.getElementById("rankBtn")){
      var btn2 = document.createElement("button");
      btn2.className = "btn";
      btn2.id = "rankBtn";
      btn2.textContent = "ğŸ† é€å‡ºæ’è¡Œæ¦œ";
      btn2.onclick = function(){ submitToLeaderboard(false); };
      var row = document.getElementById("finishRow");
      if(row) row.appendChild(btn2);
    }
  }else{
    $("#finish").style.display = "none";
    var carbonBox2 = document.getElementById("carbonBox");
    if(carbonBox2) carbonBox2.style.display = "none";
  }
}

function openMission(id){
  var req = requiredStop();
  var box = $("#missionBox");
  var act = $("#missionActions");
  act.style.display = "none";

  if(id !== req.id){
    box.className = "tiny muted";
    box.innerHTML = "ç›®å‰éœ€å…ˆå®Œæˆ <b>" + req.id + "ï½œ" + req.name + "</b> æ‰èƒ½è§£é–ä¸‹ä¸€é—œã€‚";
    return;
  }

  var nearOk = true;
  var distText = "";

  if(lastPos){
    var d = haversineM(lastPos.lat, lastPos.lng, req.lat, req.lng);
    nearOk = d <= req.unlockRadiusM;
    distText = "ï¼ˆè·é›¢ç´„ " + Math.round(d) + "mï¼Œè§£é–ç¯„åœ " + req.unlockRadiusM + "mï¼‰";
  }else{
    nearOk = true;
    distText = "ï¼ˆæœªå•Ÿç”¨å®šä½ï¼šä»¥ demo æ¨¡å¼é€²å…¥ï¼‰";
  }

  if(!nearOk){
    box.className = "tiny muted";
    box.innerHTML = "ä½ é‚„æ²’åˆ°é” <b>" + req.name + "</b> é™„è¿‘ï¼Œå…ˆæ­è»Šåˆ°ç«™å†æŒ‘æˆ°ï¼<br/><span class='muted'>" + distText + "</span>";
    return;
  }

  box.className = "tiny";
  box.innerHTML =
    "<div class='pill'>ğŸ“ " + req.id + "ï½œ" + req.name + "</div>" +
    "<div style='margin-top:10px;opacity:.92'>" + req.story + "</div>" +
    "<div style='margin-top:10px;font-weight:900'>è¬é¡Œï¼š</div>" +
    "<div style='margin-top:6px'>" + req.q.t + " <span class='muted'>" + distText + "</span></div>";

  act.innerHTML = "";
  for(var i=0;i<req.q.a.length;i++){
    (function(idx){
      var b = document.createElement("button");
      b.className = "btn secondary";
      b.textContent = (idx+1) + ". " + req.q.a[idx];
      b.onclick = function(){ answer(req, idx); };
      act.appendChild(b);
    })(i);
  }
  act.style.display = "flex";
}

function answer(req, pickIdx){
  var box = $("#missionBox");
  var act = $("#missionActions");

  if(pickIdx === req.q.c){
    if (!Array.isArray(state.done)) state.done = [];
    if(state.done.indexOf(req.id) < 0) state.done.push(req.id);

    state.streak = (state.streak||0) + 1;
    var bonus = Math.min(30, state.streak * 3);
    state.score = (state.score||0) + 20 + bonus;

    var idx = -1;
    for(var i=0;i<A_STOPS.length;i++){
      if(A_STOPS[i].id === req.id){ idx = i; break; }
    }
    if(idx >= 0 && idx < A_STOPS.length - 1){
      state.current = A_STOPS[idx+1].id;
    }
    save();

    var next = requiredStop();
    box.className = "tiny";
    box.innerHTML = "âœ… é€šé—œæˆåŠŸï¼ä½ ç²å¾— <b>" + (20+bonus) + "</b> åˆ†ï¼ˆé€£å‹åŠ æˆ +" + bonus + "ï¼‰ã€‚<br/>ä¸‹ä¸€é—œå·²è§£é–ï¼š<b>" + next.id + "ï½œ" + next.name + "</b>";
    act.style.display = "none";
    render();
  }else{
    state.streak = 0;
    save();
    box.className = "tiny";
    box.innerHTML = "å†è©¦ä¸€æ¬¡ï½æç¤ºï¼šé€™é¡Œç­”æ¡ˆè·Ÿã€Œåˆ°ç«™è§£é–ã€æˆ–ã€Œå°æµåˆ†äº«ã€æœ‰é—œã€‚";
  }
}

function startGPS(){
  if(!navigator.geolocation){
    $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šæ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½";
    return;
  }
  if(watchId !== null) return;

  $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šè«‹å…è¨±å®šä½â€¦";
  watchId = navigator.geolocation.watchPosition(
    function(pos){
      var lat = pos.coords.latitude;
      var lng = pos.coords.longitude;
      var acc = Math.round(pos.coords.accuracy || 0);
      lastPos = { lat:lat, lng:lng, acc:acc, t:Date.now() };

      $("#locText").textContent = "lat " + lat.toFixed(6) + ", lng " + lng.toFixed(6) + "ï¼ˆç²¾åº¦ç´„ " + acc + "mï¼‰";

      var req = requiredStop();
      var d = haversineM(lat, lng, req.lat, req.lng);
      var near = d <= req.unlockRadiusM;

      $("#nearText").textContent = "è·é›¢ä¸‹ä¸€é—œã€Œ" + req.name + "ã€ç´„ " + Math.round(d) + "mï¼ˆ" + (near ? "âœ… å¯è§£é–" : "ğŸ”’ æœªåˆ°é”") + "ï¼‰";
      $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šå·²å•Ÿç”¨ï¼ˆå³æ™‚æ›´æ–°ä¸­ï¼‰";

      if(near) openMission(req.id);
    },
    function(err){
      $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šå•Ÿç”¨å¤±æ•—ï¼ˆè«‹åœ¨ç€è¦½å™¨è¨­å®šå…è¨±å®šä½ï¼‰";
      $("#locText").textContent = "éŒ¯èª¤ï¼š" + (err.message || err.code);
    },
    { enableHighAccuracy:true, maximumAge:2000, timeout:12000 }
  );
}

function stopGPS(){
  if(watchId !== null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    $("#gpsStatus").textContent = "å®šä½ç‹€æ…‹ï¼šå·²åœæ­¢";
    $("#nearText").textContent = "";
  }
}

function showCoupon(){
  if (!state.deviceId) state.deviceId = Math.random().toString(16).slice(2,10);
  save();
  $("#couponHint").textContent = "ç¤ºç¯„å…Œæ›ç¢¼ï¼šKM-A-RIDDLE-" + String(state.deviceId).toUpperCase() + "ï¼ˆæ­£å¼ç‰ˆå»ºè­°å¾Œç«¯æ ¸éŠ·ï¼‰";
}

function share(){
  var text = "æˆ‘å‰›å®Œæˆå°ç£å¥½è¡Œé‡‘é–€ " + ROUTE_NAME + " çš„ã€Œå³æ™‚è·¯ç·šè§£è¬ã€ğŸšŒğŸ§© åˆ†æ•¸ " + state.score + "ï¼#å°ç£å¥½è¡Œ #é‡‘é–€";
  if(navigator.share){
    navigator.share({ title:"å°ç£å¥½è¡Œé‡‘é–€ï½œå³æ™‚è·¯ç·šè§£è¬", text:text })["catch"](function(){});
  }else{
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(function(){ alert("å·²è¤‡è£½åˆ†äº«æ–‡æ¡ˆåˆ°å‰ªè²¼ç°¿ï¼"); })
      ["catch"](function(){ alert(text); });
    }else{
      alert(text);
    }
  }
}

function submitToLeaderboard(auto){
  var timeSec = Math.max(1, Math.round((Date.now() - (state.startAt || Date.now())) / 1000));

  if(state.sentToBoard){
    if(!auto) alert("é€™ä¸€å±€å·²é€å‡ºæ’è¡Œæ¦œå›‰ï¼");
    return;
  }
  state.sentToBoard = true;
  save();

  var name = state.playerName || "ç©å®¶";
  var stopId = normCode(CURRENT_STOP);
  var note = "Aç·šå³æ™‚è§£è¬";

  var url = new URL(LEADERBOARD_URL);
  url.searchParams.set("game", "riddle");
  url.searchParams.set("name", name);
  url.searchParams.set("score", String(state.score || 0));
  url.searchParams.set("time", String(timeSec));
  url.searchParams.set("stop", stopId || "A01");
  url.searchParams.set("note", note);

  location.href = url.toString();
}

/* ===== buttons ===== */
$("#gpsBtn").onclick = startGPS;
$("#gpsStopBtn").onclick = stopGPS;

$("#manualGoBtn").onclick = function(){
  openMission($("#manualSelect").value);
};
$("#codeGoBtn").onclick = function(){
  var code = normCode($("#codeInput").value);
  openMission(code);
};

$("#resetBtn").onclick = function(){
  localStorage.removeItem(KEY);
  location.href = location.pathname + "?v=" + Date.now();
};

$("#couponBtn").onclick = showCoupon;
$("#shareBtn").onclick = share;

/* ===== boot ===== */
(function boot(){
  render();

  var pill = document.getElementById("pagePill");
  if(pill){
    pill.textContent = "ğŸšŒ å°ç£å¥½è¡Œé‡‘é–€ï½œå³æ™‚è·¯ç·šè§£è¬ï¼ˆAç·šï¼‰ï½œç›®å‰ç«™é»ï¼š" + CURRENT_STOP_NAME + "ï¼ˆ" + CURRENT_STOP + "ï¼‰";
  }

  // æ”¯æ´ ?stop=A10ï¼ˆä»éµå¾ªé †åºè¦å‰‡ï¼‰
  var url = new URL(location.href);
  var stop = url.searchParams.get("stop");
  if(stop){
    var code = normCode(stop);
    $("#codeInput").value = code;
    openMission(code);
  }else{
    openMission(state.current);
  }
})();
</script>

</body>
</html>
